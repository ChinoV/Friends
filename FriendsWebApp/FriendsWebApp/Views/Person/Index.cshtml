<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>List</title>
    <!--jQuery-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!--Data Table-->
    <script type="text/javascript" src=" https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src=" https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="~/css/StyleSheet.css" />

    <style>
    </style>
    <script>
        $(document).ready(function () {


            //<!--Chargin DataTables   -- >
            $.ajax({
                type: "GET",
                url: "/Person/GetPeople",
                data: "",
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //<!--DataTables  Initialization -- >
                    $table = $('#PeopleTable').DataTable({
                        responsive: true,
                        "order": [[1, "asc"]],
                        "data": data,
                        "columns": [
                            { "data": "personId" },
                            { "data": "name" },
                            { "data": "lastName" },
                            {
                                "defaultContent": "<div style =\"text-align:center;\">"
                                    + "<button class='btn btn-warning text-white' data-toggle='modal' data-target='#ModalPerson' title='Edit'  onclick = \"editRow(this)\"><i class='fa fa-edit'></i></button>  "
                                    + "<button class='btn btn-danger text-white' data-toggle='modal' data-target='#DeleteModalPerson' onclick = \"removePerson(this)\" title='Delete'><i class='fa fa-trash'></i></button>  "
                                    + "</div>"
                            },
                            {
                                "defaultContent": "<div style =\"text-align:center;\">"
                                    + "<button class=\"btn btn-primary text-white\" title=\"ShowFriends\"><i class=\"fa fa-eye\"></i></button>  "
                                    + "<button  id='btnAddFriend' class='btn btn-success text-white' data-toggle='modal' data-target='#ModalFriend' onclick = \"ChargeFriendSelect(this)\"><i class='fa fa-user-plus'></i></button>  "
                                    + "<button  class='btn btn-danger text-white' data-toggle='modal' data-target='#RemoveFriendModal' onclick = \"LoadRemoveFriend(this)\"><i class='fa fa-user-times'></i></button>  "
                                    + "</div>"
                            }
                        ],
                        "columnDefs": [
                            {
                                "targets": [0],
                                "visible": false,
                                "searchable": false
                            }
                        ]
                    });

                },
                error: function () {
                    Console.log("error, ajax couldn't charge the table")
                }

            });

            //<!--clean Create Person -- >
            $("#ModalPerson").on('hidden.bs.modal', function () {
                $("#HiddenIndexDelete").val("");
                $(".modal-body #UserId").val("");
                $(".modal-body #formName").val("");
                $(".modal-body #formLastName").val("");
                $("#BtnCreatePerson").css("display", "inline");
                $("#BtnEditPerson").css("display", "none");
                $("#UserId").css("display", "none");
                $("#titleModel").text("Create new Person");
            });

            //<!--clean Remove Friend -- >
            $("#RemoveFriendModal").on('hidden.bs.modal', function () {
                $("#RemoveFriendPersonId").val("");
                $("#FriendsSelect").children('option:not(:first)').remove();
            });


            //<!--Delete Person -- >
            $("#yesDelete").click(function () {

                $.ajax({
                    type: "DELETE",
                    url: "/Person/Delete",
                    data: JSON.stringify($("#HiddenIndexDelete").val()),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        if (data) {
                            $table.row($("#indexId").val()).remove().draw();
                            ValidateMyAlert("Class='alert alert-success'", 'the person with the id ' + $("#HiddenIndexDelete").val()+' was Deleted', 'success', "#alertContainer");
                        }
                        else {
                            ValidateMyAlert("Class='alert alert-warning'", ' Could not delete ', 'Warning', "#alertContainer");
                        }
                    },
                    error: function () {
                        //ValidateMyAlert("Class='alert alert-danger'", 'error', 'Danger', "#alertContainer");
                    }
                });
                $("#closeDeleteModal").click();
            })

        });

        function CreatePerson() {
            $.ajax({
                type: "POST",
                url: "/Person/Create",
                data: JSON.stringify({
                    Name: $("#formName").val(),
                    LastName: $("#formLastName").val()
                }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    if (data) {
                        console.log(data)
                        var obj = {
                            personId: data.personId,
                            name: data.name,
                            lastName: data.lastName
                        };
                        console.log(obj.personId);
                        $table.row.add(obj).draw();
                        $("#closeMyModal").click();
                        ValidateMyAlert("Class='alert alert-success'", 'the person was added', 'success', "#alertContainer");
                    }
                    else { ValidateMyAlert("Class='alert alert-warning'", 'Could not be added', 'Warning', "#alertContainer"); }
                },
                error: function () {
                    console.log("error, ajax couldn't Create a person")
                }
            });
        }

        function removePerson(button) {
            var actualRow = $(button).parents("tr");
            var rowIndex = $table.row(actualRow).index();
            var row = $table.row(rowIndex).data();
            $("#HiddenIndexDelete").val(row.personId);
            $("#indexId").val(rowIndex);
        }

        function editRow(button) {

            $("#BtnCreatePerson").css("display", "none");
            $("#BtnEditPerson").css("display", "inline");
            $("#UserId").css("display", "inline");
            $("#titleModel").text("Edit Person");
            var ActualRow = $(button).parents("tr");
            var rowIndex = $table.row(ActualRow).index();
            var row = $table.row(rowIndex).data();
            $("#UserId").val(row.personId);
            $("#formName").val(row.name);
            $("#formLastName").val(row.lastName);
            $("#indexId").val(rowIndex);

        }


        function EditPerson() {

            $.ajaxSetup({ async: false });
            $.ajax({
                type: "PUT",
                url: "/Person/Edit",
                data: JSON.stringify({
                    personId: $("#UserId").val(),
                    name: $("#formName").val(),
                    lastName: $("#formLastName").val(),
                }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    if (data) {

                        $.ajaxSetup({ async: false });
                        $.ajax({
                            type: "PUT",
                            url: "/Person/Edit",
                            data: JSON.stringify({
                                personId: $("#UserId").val(),
                                name: $("#formName").val(),
                                lastName: $("#formLastName").val(),
                            }),
                            dataType: "json",
                            contentType: 'application/json; charset=utf-8',
                            success: function (data) {
                                if (data) {

                                    console.log(data);
                                    var obj = {
                                        personId: data.personId,
                                        name: data.name,
                                        lastName: data.lastName
                                    }
                                    $table.row($("#indexId").val()).data(obj).draw();
                                    $("#closeMyModal").click();
                                }
                                else {
                                    //ValidateMyAlert("Class='alert alert-warning'", 'Something is wrong', 'Warning', "#alertContainer");
                                }
                            },
                            error: function () {
                                //ValidateMyAlert("Class='alert alert-danger'", 'Error whith edit', 'Danger', "#alertContainer");
                            }
                        });
                    }
                }
            });
        }


        //<!--charge friend -- >
        function ChargeFriendSelect(button) {

            var ActualRow = $(button).parents("tr");
            var rowIndex = $table.row(ActualRow).index();
            var row = $table.row(rowIndex).data();
            $("#ActualId").val(row.personId);
            $.ajax({
                type: "POST",
                url: "/Person/GetNoneFriends",
                data: JSON.stringify($("#ActualId").val(), 2),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {

                    var listItems = '<option selected="selected" value="-1">Select a friend</option>';
                    for (var i = 0; i < data.length; i++) {
                        listItems += "<option value='" + data[i].personId + "'>" + data[i].name + "</option>";
                    }
                    $("#listPeople").html(listItems);
                },
                error: function () {
                    console.log("error, ajax couldn't charge the table");
                }
            });
            $('#modalHeaderFriendTitle').html('Add New Friend');

        }

        //<!--add friend relationship-- >
        function linkFriends() {
            $.ajax({
                type: "POST",
                url: "/Person/LinkFriends",
                data: JSON.stringify({
                    Id1: $("#ActualId").val(),
                    Id2: $("#listPeople option:selected").val()
                }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $("#CloseAddFriendModal").click();
                },
                error: function () {
                    console.log("error, ajax couldn't charge the table");
                }
            });
        }

        function LoadRemoveFriend(button) {

            var actualRow = $(button).parents("tr");
            var rowIndex = $table.row(actualRow).index();
            var row = $table.row(rowIndex).data();
            $("#RemoveFriendPersonId").val(row.personId);

            $.ajax({
                type: "POST",
                url: "/Person/GetFriends",
                data: JSON.stringify($("#RemoveFriendPersonId").val()),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $.each(data, function () {
                        $("#FriendsSelect").append("<option value=" + this.personId + ">" + this.name + "</option>");
                    });
                },
                error: function () {
                    Console.log("error, ajax couldn't charge the select for the remove friend")
                }
            });
        }

        function RemoveFriend() {

            console.log($("#RemoveFriendPersonId").val() + "  " + $("#FriendsSelect").val())
            $.ajax({
                type: "POST",
                url: "/Person/RemoveFriendhip",
                data: JSON.stringify({ Id1: $("#RemoveFriendPersonId").val(), Id2: $("#FriendsSelect").val() }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    if (data) {
                        console.log("success remove friend")
                        $("#closeMyModalRemove").click();
                    }
                },
                error: function () {
                    console.log("error, ajax couldn't remove a friend")
                }
            });
        }


        //Validations
        function ValidateMyAlert(pClass, pString, tMessege, insertSide) {
            if (!$("p[" + pClass + "]").length) {
                $(insertSide).prepend("<p " + pClass + "><strong>" + tMessege + "</strong> " + pString + " </p>");
            }
            else {
                $("p[" + pClass + "]").remove();
                $(insertSide).prepend("<p " + pClass + "><strong>" + tMessege + "</strong> " + pString + " </p>");
            }
        }

    </script>
</head>
<body>
    <div class="container">
        <br>

        <h2 class="text-center">People List</h2>
        <br />
        <div id="alertContainer"> </div>
        <br />
        <a class="btn btn-primary" data-toggle="modal" data-target="#ModalPerson"><strong>Nuevo</strong> <i class="fa fa-plus"></i></a>
        <br />
        <br />

        <table id="PeopleTable" class="table table-bordered table-striped" style="width:100%">
            <thead class="text-center">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Last Name</th>
                    <th>Person options</th>
                    <th>Friend options</th>
                </tr>
            </thead>
        </table>
    </div>

    <!--Create, Edit Modal-->
    <div class="modal fade" id="ModalPerson" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header text-center">

                    <button type="button" class="close" data-dismiss="modal" id="closeMyModal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                    <h4 class="modal-title w-100  font-weight-bold" id="titleModel">Create new Person</h4>

                </div>

                <div class="modal-body mx-3">
                    <input id="UserId" name="UserId" type="hidden" value="0">
                    <div class="md-form mb-5">
                        <i class="fa fa-user  prefix grey-text"></i>
                        <input type="text" id="formName" class="form-control validate">
                        <label data-error="wrong" data-success="right" for="formName">Name</label>
                    </div>

                    <div class="md-form mb-5">
                        <i class="fa fa-vcard-o prefix grey-text"></i>
                        <input type="text" id="formLastName" class="form-control validate">
                        <label data-error="wrong" data-success="right" for="formLastName">Last Name</label>
                    </div>

                    <input type="text" class=" form-control HiddenIndexx" style="display:none" id="indexId" />

                    <div class="modal-footer d-flex justify-content-center">
                        <button class="btn btn-success" id="BtnCreatePerson" onclick="CreatePerson()">Create</button>
                        <button type="button" class="btn btn-success" id="BtnEditPerson" onclick="EditPerson()" style="display:none">Edit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!--Remove friend Modal-->
    <div class="modal fade" id="RemoveFriendModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header text-center">

                    <button type="button" class="close" data-dismiss="modal" id="closeMyModalRemove" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                    <h4 class="modal-title w-100  font-weight-bold" id="titleModel">Remove friend</h4>

                </div>

                <div class="modal-body mx-3">
                    <input id="RemoveFriendPersonId" type="hidden" value="0">
                    <div class="md-form mb-5">
                        <i class="fa fa-users"></i>
                        <select id="FriendsSelect" class="form-control">
                            <option value="-1" selected>select a friend</option>
                        </select>
                    </div>

                    <div class="modal-footer d-flex justify-content-center">
                        <button class="btn btn-danger" id="BtnRemoveFriend" onclick="RemoveFriend()">Remove</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="DeleteModalPerson" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="titleModelDelete">Delete</h4>
                </div>
                <div id="rowModalBody" class="modal-body">
                    <label for="usr">Are you sure you want to delete this person?</label><br>
                    <button type="button" class="btn btn-default" id="yesDelete">Yes</button>
                    <button type="button" class="btn btn-default" id="noDelete" data-dismiss="modal">No</button>
                    <input type="text" class="HiddenIndexx" id="HiddenIndexDelete" style="display:none" />
                </div>
            </div>
        </div>
    </div>

    <!--Add Friend Modal-->
    <div>
        <div id="frmAddFriend">
            <input type="hidden" id="ActualId" name="Id" value="">
            <div class="modal fade" id="ModalFriend" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div id="modalForm" class="modal-content">
                        <div class="modal-header text-center">
                            <button type="button" class="close" data-dismiss="modal" id="CloseAddFriendModal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title w-100 font-weight-bold" id="modalHeaderFriendTitle">Add Friend</h4>
                        </div>
                        <div class="modal-body">
                            <i class="fa fa-users"></i>
                            <select id="listPeople" name="firstname" class="form-control">
                                <option></option>
                            </select>


                            <div class="modal-footer d-flex justify-content-center">
                                <button class="btn btn btn-primary" onclick="linkFriends()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>